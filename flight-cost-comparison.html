<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>GA vs. Airline Cost &amp; Time Calculator (3 gal per Fuel Stop)</title>
  <style>
    body {
      font-family: Arial, sans-serif; 
      margin: 20px;
      max-width: 700px;
    }
    label {
      display: inline-block;
      width: 210px;
      margin-bottom: 6px;
    }
    input, select, button {
      margin-bottom: 6px;
    }
    .result {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }
    .result span {
      font-weight: bold;
    }
    hr {
      margin: 12px 0;
    }

    /* Simple modal styling (used for customizing/adding planes if needed) */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none; /* Hidden by default */
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      width: 300px;
      box-shadow: 0 0 10px rgba(0,0,0,0.25);
    }
    .modal-content h3 {
      margin-top: 0;
    }
    .modal-buttons {
      margin-top: 10px;
      text-align: right;
    }
    .modal-buttons button {
      margin-left: 6px;
    }
  </style>
</head>
<body>

<h1>GA vs. Airline Cost &amp; Time Calculator</h1>

<form id="costForm" onsubmit="return false;">
  <!-- 1. Number of Passengers & Airfare -->
  <div>
    <label for="numPassengers"># of Passengers:</label>
    <input type="number" id="numPassengers" value="2" min="1" />
  </div>
  <div>
    <label for="airfare">Airfare per Person ($):</label>
    <input type="number" id="airfare" value="300" min="0" />
  </div>

  <hr>

  <!-- 2. Distance & Reservation Hours -->
  <div>
    <label for="distance">Distance One-Way (NM):</label>
    <input type="number" id="distance" value="300" min="0" />
  </div>
  <div>
    <label for="reservationHrs">Reservation Length (hrs):</label>
    <input type="number" id="reservationHrs" value="24" min="0" />
    <small>(for minimum Hobbs)</small>
  </div>
  
  <div>
    <label for="planeType">Aircraft Type:</label>
    <select id="planeType">
      <option value="DA40">DA40 XLS ($219/hr, 9.5 gph, ~140 KTAS)</option>
      <option value="SR20">Cirrus SR20 G7 ($329/hr, 11 gph, ~155 KTAS)</option>
    </select>
    <br/>
    <!-- Buttons to customize or add planes if desired -->
    <button type="button" onclick="openCustomizeModal()">Customize Plane Data</button>
    <button type="button" onclick="openAddPlaneModal()">Add New Airplane</button>
  </div>

  <hr>

  <!-- 3. Fuel & Fuel Stops -->
  <div>
    <label for="usableFuel">Usable Fuel Onboard (gal):</label>
    <input type="number" id="usableFuel" value="40" min="0" />
    <small>(after W&amp;B)</small>
  </div>
  <div>
    <label for="fuelStopTime">Fuel Stop Overhead (hrs):</label>
    <input type="number" id="fuelStopTime" value="0.5" step="0.1" min="0" />
    <small>(time on ground per stop)</small>
  </div>
  <div>
    <label for="extraHobbsPerStop">Extra Hobbs per Fuel Stop (hrs):</label>
    <input type="number" id="extraHobbsPerStop" value="0.5" step="0.1" min="0" />
    <small>(run-up, T/O, climb)</small>
  </div>

  <hr>

  <!-- 4. FBO Fees -->
  <div>
    <label for="fboFeePerFuelStop">Fuel Stop FBO Fee ($/stop):</label>
    <input type="number" id="fboFeePerFuelStop" value="0" step="1" min="0" />
  </div>
  <div>
    <label for="fboFeeDestination">Destination FBO Fee ($):</label>
    <input type="number" id="fboFeeDestination" value="0" step="1" min="0" />
    <small>(overnight, ramp, handling, etc.)</small>
  </div>

  <hr>

  <!-- 5. GA Overhead Time -->
  <div>
    <label for="gaOverhead">GA Overhead (hrs):</label>
    <input type="number" id="gaOverhead" value="1" step="0.1" min="0" />
    <small>(preflight, postflight, etc.)</small>
  </div>

  <hr>

  <!-- 6. Airline Time Inputs -->
  <div>
    <label for="airlineFlightTime">Airline Flight Time (hrs):</label>
    <input type="number" id="airlineFlightTime" value="4" step="0.1" min="0" />
    <small>(total in-flight)</small>
  </div>
  <div>
    <label for="airlineOverhead">Airline Overhead (hrs):</label>
    <input type="number" id="airlineOverhead" value="3" step="0.1" min="0" />
    <small>(security, check-in, etc.)</small>
  </div>

  <hr>

  <button onclick="calculateCosts()">Calculate</button>
</form>

<div id="results" class="result" style="display:none;"></div>

<!-- ========== MODALS BELOW (customizing / adding planes) ========== -->
<div class="modal-overlay" id="planeModal">
  <div class="modal-content">
    <h3>Customize Existing Plane</h3>
    <div>
      <label>Wet Rate ($/hr):</label>
      <input type="number" id="modalRate" step="1" />
    </div>
    <div>
      <label>Cruise Speed (kt):</label>
      <input type="number" id="modalSpeed" step="1" />
    </div>
    <div>
      <label>Fuel Burn (gph):</label>
      <input type="number" id="modalGph" step="0.1" />
    </div>

    <div class="modal-buttons">
      <button type="button" onclick="saveCustomize()">Save</button>
      <button type="button" onclick="closeCustomizeModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="addPlaneModal">
  <div class="modal-content">
    <h3>Add New Airplane</h3>
    <div>
      <label>Plane Name:</label>
      <input type="text" id="modalNewName" placeholder="e.g. C172" />
    </div>
    <div>
      <label>Wet Rate ($/hr):</label>
      <input type="number" id="modalNewRate" step="1" />
    </div>
    <div>
      <label>Cruise Speed (kt):</label>
      <input type="number" id="modalNewSpeed" step="1" />
    </div>
    <div>
      <label>Fuel Burn (gph):</label>
      <input type="number" id="modalNewGph" step="0.1" />
    </div>

    <div class="modal-buttons">
      <button type="button" onclick="saveAddPlane()">Add</button>
      <button type="button" onclick="closeAddPlaneModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
  /******************************************************
   *  Constants / Data
   ******************************************************/

  // We assume each fuel stop requires 3 gallons for taxi/run-up/climb:
  const CLIMB_GALS_PER_STOP = 3;

  // Built-in planes:
  const planes = {
    "DA40": { rate: 219, speed: 140, gph: 9.5 },
    "SR20": { rate: 329, speed: 155, gph: 11 },
  };

  /******************************************************
   *  Modal logic: Customize existing plane
   ******************************************************/
  function openCustomizeModal() {
    const planeKey = document.getElementById("planeType").value;
    const plane = planes[planeKey];
    if (!plane) return;

    document.getElementById("modalRate").value  = plane.rate;
    document.getElementById("modalSpeed").value = plane.speed;
    document.getElementById("modalGph").value   = plane.gph;

    document.getElementById("planeModal").style.display = "flex";
  }
  function closeCustomizeModal() {
    document.getElementById("planeModal").style.display = "none";
  }
  function saveCustomize() {
    const planeKey = document.getElementById("planeType").value;
    const plane = planes[planeKey];
    if (!plane) return;

    const newRate  = parseFloat(document.getElementById("modalRate").value);
    const newSpeed = parseFloat(document.getElementById("modalSpeed").value);
    const newGph   = parseFloat(document.getElementById("modalGph").value);

    if (!isNaN(newRate))  plane.rate  = newRate;
    if (!isNaN(newSpeed)) plane.speed = newSpeed;
    if (!isNaN(newGph))   plane.gph   = newGph;

    closeCustomizeModal();
  }

  /******************************************************
   *  Modal logic: Add a new plane
   ******************************************************/
  function openAddPlaneModal() {
    // Clear fields
    document.getElementById("modalNewName").value  = "";
    document.getElementById("modalNewRate").value  = "";
    document.getElementById("modalNewSpeed").value = "";
    document.getElementById("modalNewGph").value   = "";

    document.getElementById("addPlaneModal").style.display = "flex";
  }
  function closeAddPlaneModal() {
    document.getElementById("addPlaneModal").style.display = "none";
  }
  function saveAddPlane() {
    const newName  = document.getElementById("modalNewName").value.trim();
    const newRate  = parseFloat(document.getElementById("modalNewRate").value);
    const newSpeed = parseFloat(document.getElementById("modalNewSpeed").value);
    const newGph   = parseFloat(document.getElementById("modalNewGph").value);

    if (!newName) {
      alert("Plane Name is required.");
      return;
    }
    if (isNaN(newRate) || isNaN(newSpeed) || isNaN(newGph)) {
      alert("Please enter valid numeric values for Rate, Speed, and GPH.");
      return;
    }

    // Add or update the 'planes' dictionary
    planes[newName] = { rate: newRate, speed: newSpeed, gph: newGph };

    // Add <option> to the <select> if it doesn't exist
    const planeSel = document.getElementById("planeType");
    let existingOpt = [...planeSel.options].find(opt => opt.value === newName);
    if (!existingOpt) {
      const newOpt = document.createElement("option");
      newOpt.value = newName;
      newOpt.text  = newName;
      planeSel.appendChild(newOpt);
    }

    // Optionally select the newly added plane
    planeSel.value = newName;

    closeAddPlaneModal();
  }

  /******************************************************
   *  Function to compute # of stops ignoring climb usage
   ******************************************************/
  function getFuelStopsNeeded(totalFlightTime, flightEndurance) {
    if (totalFlightTime <= flightEndurance) {
      return 0;
    }
    const ratio = totalFlightTime / flightEndurance;
    return Math.ceil(ratio) - 1;
  }

  /******************************************************
   *  Main "Calculate" function
   *  Incorporates iterative approach for 3 gallons/stop
   ******************************************************/
  function calculateCosts() {
    // 1. Grab user inputs
    const numPassengers     = parseFloat(document.getElementById("numPassengers").value) || 0;
    const airfarePerPerson  = parseFloat(document.getElementById("airfare").value)       || 0;
    const distanceNM        = parseFloat(document.getElementById("distance").value)      || 0;
    const reservationHrs    = parseFloat(document.getElementById("reservationHrs").value)|| 0;
    const selectedPlane     = document.getElementById("planeType").value;

    const usableFuel        = parseFloat(document.getElementById("usableFuel").value)    || 0;
    const fuelStopTime      = parseFloat(document.getElementById("fuelStopTime").value)  || 0;
    const extraHobbsPerStop = parseFloat(document.getElementById("extraHobbsPerStop").value) || 0;
    const fboFeePerFuelStop = parseFloat(document.getElementById("fboFeePerFuelStop").value) || 0;
    const fboFeeDestination = parseFloat(document.getElementById("fboFeeDestination").value) || 0;
    const gaOverhead        = parseFloat(document.getElementById("gaOverhead").value)    || 0;
    const airlineFlightTime = parseFloat(document.getElementById("airlineFlightTime").value) || 0;
    const airlineOverhead   = parseFloat(document.getElementById("airlineOverhead").value)   || 0;

    // 2. Airline cost
    const totalAirlineCost = numPassengers * airfarePerPerson;

    // 3. Lookup plane data
    const plane = planes[selectedPlane];
    if (!plane) {
      alert("Please select or add a valid airplane.");
      return;
    }
    const rate = plane.rate;
    const speed = plane.speed;
    const gph = plane.gph;

    // 4. Round-trip flight time (no stops)
    const rawGaFlightTime = 2 * (distanceNM / speed);

    // 5. Start by subtracting 1 hr reserve from total usableFuel
    const reserveGallons = gph * 1;  // 1 hour reserve
    // We'll do an iterative approach to factor in 3 gallons used per stop

    let bestGuessStops = 0;   // initial guess
    let prevStops = -1;       // track changes
    let iteration = 0;
    const MAX_ITER = 10;      // to avoid infinite loops

    while (bestGuessStops !== prevStops && iteration < MAX_ITER) {
      iteration++;
      prevStops = bestGuessStops;

      // If we plan for 'bestGuessStops', we burn 3 gallons for each stop
      // so effectively we lose (3*gallons * bestGuessStops) from total usable
      // for actual cruising.
      const totalExtraClimbGallons = CLIMB_GALS_PER_STOP * bestGuessStops;
      const effectiveUsable = Math.max(0, usableFuel - reserveGallons - totalExtraClimbGallons);
      const flightEndurance = effectiveUsable / gph;

      bestGuessStops = getFuelStopsNeeded(rawGaFlightTime, flightEndurance);
    }

    const fuelStops = bestGuessStops;  // final number of stops

    // 6. Now that we have the final # of stops, compute final flight endurance
    const finalExtraClimbGallons = CLIMB_GALS_PER_STOP * fuelStops;
    const finalUsable = Math.max(0, usableFuel - reserveGallons - finalExtraClimbGallons);
    const finalFlightEndurance = finalUsable / gph;

    // 7. Billable flight time = raw flight time + extra Hobbs for each stop
    let billableFlightTime = rawGaFlightTime + (fuelStops * extraHobbsPerStop);

    // 8. Minimum Hobbs
    let minHobbs = getMinHobbsHours(reservationHrs);
    const billableHours = Math.max(billableFlightTime, minHobbs);

    // 9. GA cost: (billable hours * rate) + FBO fees
    let gaCost = billableHours * rate;
    const totalFboFees = (fuelStops * fboFeePerFuelStop) + fboFeeDestination;
    gaCost += totalFboFees;

    // 10. GA total travel time
    const actualGaTravelTime = rawGaFlightTime + (fuelStops * fuelStopTime) + gaOverhead;

    // 11. Airline total travel time
    const totalAirlineTime = airlineFlightTime + airlineOverhead;

    /**************************************************************
     * 12. Prepare & display results
     **************************************************************/
    let html = "<h2>Results</h2>";

    // COST
    html += "<p><strong>Airline Cost:</strong> $" + totalAirlineCost.toFixed(0) + "</p>";
    html += "<p><strong>GA Cost (" + selectedPlane + "):</strong> $" + gaCost.toFixed(0) + "</p>";

    if (gaCost < totalAirlineCost) {
      html += "<p>You <span>save money</span> by flying yourself (in pure dollar terms).</p>";
    } else if (gaCost > totalAirlineCost) {
      html += "<p>The <span>airline is cheaper</span> than GA in pure dollar terms.</p>";
    } else {
      html += "<p>It's basically a <span>tie</span> in pure cost!</p>";
    }

    html += "<hr>";

    // TIME
    html += "<p><strong>GA Travel Time (total):</strong> " 
          + actualGaTravelTime.toFixed(1) + " hrs</p>";
    html += "<ul>";
    html += "<li><strong>Raw flight time:</strong> " + rawGaFlightTime.toFixed(2) + " hrs</li>";
    html += "<li><strong>Fuel stops:</strong> " + fuelStops + "</li>";
    html += "<li><strong>Fuel stop overhead:</strong> " 
          + (fuelStops * fuelStopTime).toFixed(1)
          + " hrs total (" + fuelStopTime + " hrs each)</li>";
    html += "<li><strong>GA overhead:</strong> " + gaOverhead.toFixed(1) + " hrs</li>";
    html += "</ul>";

    html += "<p><strong>Airline Travel Time (total):</strong> " 
          + totalAirlineTime.toFixed(1) + " hrs</p>";
    html += "<ul>";
    html += "<li><strong>In-flight:</strong> " + airlineFlightTime.toFixed(2) + " hrs</li>";
    html += "<li><strong>Overhead (security, check-in):</strong> " 
          + airlineOverhead.toFixed(1) + " hrs</li>";
    html += "</ul>";

    if (actualGaTravelTime < totalAirlineTime) {
      html += "<p>You <span>save time</span> flying GA!</p>";
    } else if (actualGaTravelTime > totalAirlineTime) {
      html += "<p>The airline is <span>faster</span> overall.</p>";
    } else {
      html += "<p>They're <span>equal</span> in total time!</p>";
    }

    html += "<hr>";

    // Additional details
    html += "<p><strong>Billable Flight Time (with stops):</strong> " 
          + billableFlightTime.toFixed(2) + " hrs</p>";
    html += "<p><strong>Minimum Hobbs Required:</strong> " 
          + minHobbs.toFixed(2) + " hrs</p>";
    html += "<p><strong>Final Billable GA Hours:</strong> " 
          + billableHours.toFixed(2) + "</p>";
    html += "<p><strong>Flight Endurance (excl. 1hr reserve & climb usage):</strong> " 
          + finalFlightEndurance.toFixed(2) + " hrs</p>";
    html += "<p><strong>FBO Fees:</strong> $" + totalFboFees.toFixed(0) + " total</p>";
    html += "<p><em>*3 gal/stop used for taxi+run-up+climb is factored into final fuel stops.</em></p>";

    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = "block";
  }
</script>

</body>
</html>
